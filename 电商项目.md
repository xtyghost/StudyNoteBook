SOA : 面向服务架构

把工程分成表现层,服务层.服务层包含业务逻辑,只需向外提供服务即可.表现层只需处理和页面的交互,业务逻辑都是调用服务层服务来实现.

### 开发流程

## day01

1. 创建acmall-parent模块(pom),管理依赖版本
2. 创建acmall-common模块(jar),继承acmall-parent,添加工具类依赖
3. 创建acmall-manager模块(pom),继承acmall-parent,添加acmall-common依赖
4. 创建acmall-pojo模块(jar),继承acmall-manager
5. 创建acmall-dao模块(jar),继承acmall-manager,添加acmall-pojo,MyBatis,MySQL,连接池依赖
6. 创建acmall-interface模块(jar),继承acmall-manager,添加acmall-pojo依赖
7. 创建acmall-service模块(jar),继承acmall-manager,添加acmall-dao,acmall-interface,Spring依赖
8. 创建acmall-web模块(war),继承acmall-manager,添加acmall-service,jsp相关依赖
9. 给acmall-manager模块添加tomcat插件
10. 导入pojo,mapper文件
11. 整合框架

sqlMapConfig.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
	<!-- 设置别名 -->
	<typeAliases>
		<package name="com.acmall.pojo" />
	</typeAliases>
</configuration>
```

applicationContext-dao.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">
    <context:property-placeholder location="classpath:conf/db.properties"/>
    <!-- 配置Druid连接池 -->
    <bean name="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
        <property name="driverClassName" value="${jdbc.driver}"/>
        <property name="url" value="${jdbc.url}"/>
        <property name="username" value="${jdbc.username}"/>
        <property name="password" value="${jdbc.password}"/>
    </bean>
    <!-- Mybatis的工厂 -->
    <bean id="sqlSessionFactoryBean" class="org.mybatis.spring.SqlSessionFactoryBean">
        <property name="dataSource" ref="dataSource"/>
        <!-- 核心配置文件的位置 -->
        <property name="configLocation" value="classpath:mybatis/sqlMapConfig.xml"/>
    </bean>
    <!-- Mapper动态代理开发   扫描 -->
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <!-- 基本包 -->
        <property name="basePackage" value="com.acmall.mapper"/>
    </bean>
</beans>
```

db.properties

```properties
jdbc.driver=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/springmvc?characterEncoding=utf-8
jdbc.username=root
jdbc.password=root
```

applicationContext-service.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:context="http://www.springframework.org/schema/context"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd">
	<!-- 配置包扫描器 -->
	<context:component-scan base-package="com.acmall.service"/>	
</beans>
```

applicationContext-trans.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
	 
	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd">
	<!-- 事务管理器 -->
	<bean id="transactionManager"	class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
		<!-- 数据源 -->
		<property name="dataSource" ref="dataSource" />
	</bean>
	<!-- 通知 -->
	<tx:advice id="txAdvice" transaction-manager="transactionManager">
		<tx:attributes>
			<!-- 传播行为 -->
			<tx:method name="save*" propagation="REQUIRED" />
			<tx:method name="insert*" propagation="REQUIRED" />
			<tx:method name="add*" propagation="REQUIRED" />
			<tx:method name="create*" propagation="REQUIRED" />
			<tx:method name="delete*" propagation="REQUIRED" />
			<tx:method name="update*" propagation="REQUIRED" />
			<tx:method name="find*" propagation="SUPPORTS" read-only="true" />
			<tx:method name="select*" propagation="SUPPORTS" read-only="true" />
			<tx:method name="get*" propagation="SUPPORTS" read-only="true" />
		</tx:attributes>
	</tx:advice>
	<!-- 切面 -->
	<aop:config>
		<aop:advisor advice-ref="txAdvice"
			pointcut="execution(* com.acmall.service..*.*(..))" />
	</aop:config>
</beans>
```

springmvc.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:context="http://www.springframework.org/schema/context"
	   xmlns:mvc="http://www.springframework.org/schema/mvc"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
        http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-4.2.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd">
	<context:component-scan base-package="com.acmall.controller" />
	<mvc:annotation-driven />
	<bean class="org.springframework.web.servlet.view.InternalResourceViewResolver">
		<property name="prefix" value="/WEB-INF/jsp/" />
		<property name="suffix" value=".jsp" />
	</bean>
</beans>
```

acmall-manager-dao中的pom.xml

```xml
<!-- 如果不添加此节点mybatis的mapper.xml文件都会被漏掉。 -->
	<build>
		<resources>
            <resource>
                <directory>src/main/java</directory>
                <includes>
                    <include>**/*.properties</include>
                    <include>**/*.xml</include>
                </includes>
                <filtering>false</filtering>
            </resource>
        </resources>
	</build>
```

## day02

### 系统间通讯

有于是SOA架构,系统间需要通讯

+ WebService: 基于soap协议,效率不高,不推荐使用
+ Restful: http+json,如果服务太多,服务间调用混乱
+ Dubbo: 使用RPC协议进行远程调用,直接使用socket通讯,传输效率高,并且可以监控服务间调用关系,调用次数

#### Zookeeper安装

```shell
# 安装JDK
# 解压
tar -zxvf zookeeper-3.4.6.tar.gz
# 进入zookeeper目录,创建data目录
# 修改conf目录下zoo_sample.cfg为zoo.cfg
# 修改zoo.cfg中dataDir=data目录路径
# 启动
bin/zkServer.sh start
# 关闭
bin/zkServer.sh stop
# 查看状态
bin/zkServer.sh status
# 默认运行在2181端口
# 如果启动不成功,删除data/zookeeper_server.pid文件
```

#### 添加Dubbo和zookeeper依赖

acmall-manager-service中的pom.xml

```xml
<!-- dubbo相关 -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>dubbo</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.springframework</groupId>
                    <artifactId>spring</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>org.jboss.netty</groupId>
                    <artifactId>netty</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github.sgroschupf</groupId>
            <artifactId>zkclient</artifactId>
        </dependency>
```

#### 使用Dubbo发布服务

applicationContext-service.xml

```xml
<!-- 使用dubbo发布服务 -->
	<!-- 发布服务的服务名 -->
	<dubbo:application name="acmall-manager" />
	<!-- 配置注册中心，集群配置多个ip "10.211.55.32:2181,10.211.55.33:2181" -->
	<dubbo:registry protocol="zookeeper" address="10.211.55.32:2181" />
	<!-- 用dubbo协议在20880端口暴露服务,不同服务端口不能重复 -->
	<dubbo:protocol name="dubbo" port="20880" />
	<!-- 声明需要暴露的服务接口 -->
	<dubbo:service interface="com.acmall.service.ItemService" ref="itemServiceImpl" timeout="600000"/>
```

#### 使用Dubbo引用服务

springmvc.xml

```xml
<!-- 引用dubbo服务 -->
	<dubbo:application name="e3-manager-web"/>
	<dubbo:registry protocol="zookeeper" address="10.211.55.32:2181"/>
	<dubbo:reference interface="com.acmall.service.ItemService" id="itemService" />
```

pojo类需要实现Serializable接口

### 后台管理

```java
@Controller
public class PageController {
    /**
     * 显示后台管理首页
     * @return
     */
    @RequestMapping("/")
    public String toIndex(){
        return "index";
    }

    /**
     * 显示后台管理页面跳转
     * @param page
     * @return
     */
    @RequestMapping("/{page}")
    public String showPage(@PathVariable String page){
        return page;
    }
}
```

放行静态资源

```xml
<mvc:resources location="/css/" mapping="/css/**"/>
<mvc:resources location="/js/" mapping="/js/**"/>
```

#### pageHelper

##### 添加依赖

acmall-parent中的pom.xml

```xml
<properties>
	<pagehelper.version>3.4.2-fix</pagehelper.version>
</properties>
<dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.github.pagehelper</groupId>
                <artifactId>pagehelper</artifactId>
                <version>${pagehelper.version}</version>
            </dependency>
    	</dependencies>
</dependencyManagement>
```

acmall-manager-dao中的pom.xml

```xml
<dependencies>
	<dependency>
    	<groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper</artifactId>
    </dependency>
</dependencies>
```

##### 配置

sqlMapConfig.xml

```xml
<configuration>
	<plugins>
		<plugin interceptor="com.github.pagehelper.PageHelper">
			<!-- 设置数据库类型 Oracle,Mysql,MariaDB,SQLite,Hsqldb,PostgreSQL六种数据库-->        
        	<property name="dialect" value="mysql"/>
		</plugin>
	</plugins>
</configuration>
```

##### 使用

```java
public class PageHelperTest {
    @Test
    public void test01() throws Exception{
        // 初始化Spring容器
        ApplicationContext applicationConfig = new ClassPathXmlApplicationContext("classpath:spring/applicationContext-dao.xml");
        // 从容器中获取Mapper代理对象
        TbItemMapper itemMapper = applicationConfig.getBean(TbItemMapper.class);
        // 设置分页信息
        PageHelper.startPage(1,10);
        // 执行查询
        TbItemExample itemExample = new TbItemExample();
        List<TbItem> itemList = itemMapper.selectByExample(itemExample);
        // 取分页信息
        PageInfo<TbItem> pageInfo = new PageInfo<>(itemList);
        // 总记录数
        System.out.println(pageInfo.getTotal());
        // 总页数
        System.out.println(pageInfo.getPages());
    }
}
```

## day06

### 使用JedisClient连接Redis单机和集群

1. acmall-common中添加依赖

```xml
<!-- Redis客户端 -->
        <dependency>
            <groupId>redis.clients</groupId>
            <artifactId>jedis</artifactId>
        </dependency>
```

2. 添加jedis工具类